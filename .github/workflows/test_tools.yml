# TODO: Remove use of POPTUS_PKG once a release of that package is in PyPI
name: Test repository tools
env:
  CLONE_PATH:       ${{ github.workspace }}
  BENDFO_PY_PATH:   ${{ github.workspace }}/BenDFO/py
  BENDFO_DATA_PATH: ${{ github.workspace }}/BenDFO/data
  MINQ5_PY_PATH:    ${{ github.workspace }}/minq/py/minq5
  IBCDFO_PKG:       ${{ github.workspace }}/ibcdfo_pypkg
  TOOLS_PATH:       ${{ github.workspace }}/tools
  POPTUS_PKG:       ${{ github.workspace }}/POptUS/poptus_pypkg
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test_tools:
    strategy:
      matrix:
        os:             [ubuntu-latest]
        python-version: ["3.13"]
    runs-on: ${{ matrix.os }}
    steps:
      # -- General Setup Steps
      # This action requires minq
      - name: Checkout IBCDFO repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Checkout BenDFO repository
        uses: actions/checkout@v4
        with:
          repository: POptUS/BenDFO
          path: BenDFO
      - name: Checkout POptUS repository
        uses: actions/checkout@v4
        with:
          repository: POptUS/POptUS
          path: POptUS
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Setup Python with tox
        run: $CLONE_PATH/.github/workflows/setup_tox_github_action.sh ${{ runner.os }}
      - name: Build and install package
        run: |
          # Temporary upfront installation of POptUS from local clone
          # so that we don't get the placeholder package currently in PyPI
          pushd $POPTUS_PKG
          python -m pip install .
          popd
          pushd $IBCDFO_PKG
          # Build universal wheel for testing
          python -m build --wheel
          python -m pip install dist/ibcdfo-*-py3-none-any.whl
          popd
          python -m pip list

      # -- Run each tool individually
      # The check_standards action already uses
      # * check_flake8_compliance.sh and
      # * format_with_black.sh
      # so we don't test them here as well.
      - name: Use tools
        run: |
          export PYTHONPATH=$BENDFO_PY_PATH:$MINQ5_PY_PATH
          echo "PYTHONPATH=$PYTHONPATH" >> $GITHUB_ENV
          # TODO: If we ask people to install BenDFO and to add it to
          # PYTHONPATH, we shouldn't be asking them to copy across data from
          # that clone.
          cp $BENDFO_DATA_PATH/dfo.dat .
          $TOOLS_PATH/test_ibcdfo_python_installation.py
